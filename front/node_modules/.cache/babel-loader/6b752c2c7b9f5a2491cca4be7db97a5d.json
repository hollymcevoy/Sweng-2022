{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _observable = _interopRequireDefault(require(\"core-js/features/observable\"));\n\nvar _mathRandom = _interopRequireDefault(require(\"math-random\"));\n\nvar _shareObservable = _interopRequireDefault(require(\"./shareObservable\"));\n\nvar _SpeechSynthesisAudioStreamUtterance = _interopRequireDefault(require(\"./SpeechSynthesisAudioStreamUtterance\"));\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n\n    if (enumerableOnly) {\n      symbols = symbols.filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n      });\n    }\n\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        (0, _defineProperty2.default)(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction randomActivityId() {\n  return (0, _mathRandom.default)().toString(36).substr(2);\n}\n\nvar DirectLineSpeech = /*#__PURE__*/function () {\n  function DirectLineSpeech(_ref) {\n    var _this = this;\n\n    var dialogServiceConnector = _ref.dialogServiceConnector;\n    (0, _classCallCheck2.default)(this, DirectLineSpeech);\n    var connectionStatusObserver;\n    this.dialogServiceConnector = dialogServiceConnector;\n    this.activity$ = (0, _shareObservable.default)(new _observable.default(function (observer) {\n      _this._activityObserver = observer;\n      connectionStatusObserver.next(0);\n      connectionStatusObserver.next(1);\n      dialogServiceConnector.connect(function () {\n        connectionStatusObserver.next(2);\n      }, function (error) {\n        connectionStatusObserver.next(4);\n        console.warn('botframework-directlinespeech-sdk: Failed to connect', {\n          error: error\n        });\n      });\n    }));\n    this.connectionStatus$ = (0, _shareObservable.default)(new _observable.default(function (observer) {\n      connectionStatusObserver = observer;\n    }));\n\n    dialogServiceConnector.activityReceived = function (_, _ref2) {\n      var activity = _ref2.activity,\n          audioStream = _ref2.audioStream;\n\n      try {\n        _this._activityObserver && _this._activityObserver.next(_objectSpread(_objectSpread({}, activity), {}, {\n          channelData: _objectSpread(_objectSpread({}, activity.channelData), {}, {\n            speechSynthesisUtterance: new _SpeechSynthesisAudioStreamUtterance.default(audioStream)\n          }),\n          from: _objectSpread(_objectSpread({}, activity.from), {}, {\n            // Since DLSpeech service never ACK our outgoing activity, this activity must be from bot.\n            role: 'bot'\n          }),\n          // Since DLSpeech never ACK our outgoing activity, the \"replyToId\" will rarely able to point to an existing activity.\n          replyToId: undefined,\n          // Direct Line Speech server currently do not timestamp outgoing activities.\n          // Thus, it will be easier to just re-timestamp every incoming/outgoing activities using local time.\n          timestamp: new Date().toISOString()\n        }));\n      } catch (error) {\n        console.error(error);\n      }\n    };\n  }\n\n  (0, _createClass2.default)(DirectLineSpeech, [{\n    key: \"end\",\n    value: function end() {\n      try {\n        this.dialogServiceConnector.close();\n      } catch (err) {\n        if (!~err.message.indexOf('already disposed')) {\n          throw err;\n        }\n      }\n    }\n  }, {\n    key: \"postActivity\",\n    value: function postActivity(activity) {\n      // Currently, Web Chat set user ID on all outgoing activities.\n      // As Direct Line Speech maintains its own user ID, Web Chat should not set the user ID.\n      // TODO: [P2] We should move user ID into options of DirectLineJS, instead of Web Chat.\n      activity = _objectSpread(_objectSpread({}, activity), {}, {\n        from: {\n          role: 'user'\n        }\n      });\n\n      try {\n        // TODO: [P1] Direct Line Speech server currently do not ack the outgoing activities with any activity ID or timestamp.\n        var pseudoActivityId = randomActivityId();\n        var isSpeech = !!(activity.channelData && activity.channelData.speech); // Do not send the activity if it was from speech.\n\n        if (!isSpeech) {\n          // Starting from Speech SDK 1.13.0, they accept JSON text instead of JavaScript object.\n          // https://github.com/microsoft/cognitive-services-speech-sdk-js/commit/2f3a35446692b6d492a6c68e3237a48de67e293f\n          this.dialogServiceConnector.sendActivityAsync(JSON.stringify(activity));\n        }\n\n        this._activityObserver && this._activityObserver.next(_objectSpread(_objectSpread({}, activity), {}, {\n          id: pseudoActivityId,\n          timestamp: new Date().toISOString()\n        }));\n        return _observable.default.of(pseudoActivityId);\n      } catch (err) {\n        return new _observable.default(function (observer) {\n          return observer.error(err);\n        });\n      }\n    }\n  }]);\n  return DirectLineSpeech;\n}(); // Interfaces not yet implemented in Web Chat:\n// referenceGrammarId?: string,\n// getSessionId? : () => Observable<string>\n\n\nexports.default = DirectLineSpeech;","map":{"version":3,"mappings":"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","names":["randomActivityId","toString","substr","DirectLineSpeech","dialogServiceConnector","connectionStatusObserver","activity$","Observable","_this","_activityObserver","observer","next","connect","console","warn","error","connectionStatus$","activityReceived","_","activity","audioStream","channelData","speechSynthesisUtterance","SpeechSynthesisAudioStreamUtterance","from","role","replyToId","undefined","timestamp","Date","toISOString","close","err","message","indexOf","pseudoActivityId","isSpeech","speech","sendActivityAsync","JSON","stringify","id","of"],"sources":["/Users/dylanmurray/Sweng-2022/front/node_modules/botframework-directlinespeech-sdk/lib/src/DirectLineSpeech.js"],"sourcesContent":["/* eslint no-magic-numbers: [\"error\", { \"ignore\": [0, 1, 2, 4, 36] }] */\n\nimport Observable from 'core-js/features/observable';\nimport random from 'math-random';\n\nimport shareObservable from './shareObservable';\nimport SpeechSynthesisAudioStreamUtterance from './SpeechSynthesisAudioStreamUtterance';\n\nfunction randomActivityId() {\n  return random().toString(36).substr(2);\n}\n\nexport default class DirectLineSpeech {\n  constructor({ dialogServiceConnector }) {\n    let connectionStatusObserver;\n\n    this.dialogServiceConnector = dialogServiceConnector;\n\n    this.activity$ = shareObservable(\n      new Observable(observer => {\n        this._activityObserver = observer;\n\n        connectionStatusObserver.next(0);\n        connectionStatusObserver.next(1);\n\n        dialogServiceConnector.connect(\n          () => {\n            connectionStatusObserver.next(2);\n          },\n          error => {\n            connectionStatusObserver.next(4);\n\n            console.warn('botframework-directlinespeech-sdk: Failed to connect', { error });\n          }\n        );\n      })\n    );\n\n    this.connectionStatus$ = shareObservable(\n      new Observable(observer => {\n        connectionStatusObserver = observer;\n      })\n    );\n\n    dialogServiceConnector.activityReceived = (_, { activity, audioStream }) => {\n      try {\n        this._activityObserver &&\n          this._activityObserver.next({\n            ...activity,\n            channelData: {\n              ...activity.channelData,\n              speechSynthesisUtterance: new SpeechSynthesisAudioStreamUtterance(audioStream)\n            },\n            from: {\n              ...activity.from,\n              // Since DLSpeech service never ACK our outgoing activity, this activity must be from bot.\n              role: 'bot'\n            },\n            // Since DLSpeech never ACK our outgoing activity, the \"replyToId\" will rarely able to point to an existing activity.\n            replyToId: undefined,\n            // Direct Line Speech server currently do not timestamp outgoing activities.\n            // Thus, it will be easier to just re-timestamp every incoming/outgoing activities using local time.\n            timestamp: new Date().toISOString()\n          });\n      } catch (error) {\n        console.error(error);\n      }\n    };\n  }\n\n  end() {\n    try {\n      this.dialogServiceConnector.close();\n    } catch (err) {\n      if (!~err.message.indexOf('already disposed')) {\n        throw err;\n      }\n    }\n  }\n\n  postActivity(activity) {\n    // Currently, Web Chat set user ID on all outgoing activities.\n    // As Direct Line Speech maintains its own user ID, Web Chat should not set the user ID.\n    // TODO: [P2] We should move user ID into options of DirectLineJS, instead of Web Chat.\n    activity = {\n      ...activity,\n      from: { role: 'user' }\n    };\n\n    try {\n      // TODO: [P1] Direct Line Speech server currently do not ack the outgoing activities with any activity ID or timestamp.\n      const pseudoActivityId = randomActivityId();\n      const isSpeech = !!(activity.channelData && activity.channelData.speech);\n\n      // Do not send the activity if it was from speech.\n      if (!isSpeech) {\n        // Starting from Speech SDK 1.13.0, they accept JSON text instead of JavaScript object.\n        // https://github.com/microsoft/cognitive-services-speech-sdk-js/commit/2f3a35446692b6d492a6c68e3237a48de67e293f\n        this.dialogServiceConnector.sendActivityAsync(JSON.stringify(activity));\n      }\n\n      this._activityObserver &&\n        this._activityObserver.next({\n          ...activity,\n          id: pseudoActivityId,\n          timestamp: new Date().toISOString()\n        });\n\n      return Observable.of(pseudoActivityId);\n    } catch (err) {\n      return new Observable(observer => observer.error(err));\n    }\n  }\n}\n\n// Interfaces not yet implemented in Web Chat:\n// referenceGrammarId?: string,\n// getSessionId? : () => Observable<string>\n"]},"metadata":{},"sourceType":"script"}